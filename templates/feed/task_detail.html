{% extends 'base.html' %}

{% block content %}
  <div class="container">
    <h1>{{ task_instance.task.title }} <span class="badge {{ task_instance.status_colour }} fs-12">{{ task_instance.status }}</span>
        {% include 'tasks/_task_badges.html' with task=task_instance.task instance=task_instance %}
    </h1>
    <p>{{ task_instance.task.description }}</p>
    {% if task_instance.task.photo %}
        <div class="mt-3">
            <img src="{{ task_instance.task.photo.url }}" class="img-fluid" alt="{{ task_instance.task.title }}">
        </div>
    {% endif %}
    <hr>
    <h2>Comments</h2>
    <div id="comments-container" class="mb-3" style="max-height: 400px; overflow-y: scroll;">
        {% for comment in comments %}
            <div class="card mb-2">
                <div class="card-body">
                    <h5 class="card-title">{{ comment.user.profile.name }}</h5>
                    <p class="card-text">{{ comment.text }}</p>
                    <p class="card-text text-muted">{{ comment.created_at|date:"H:i \o\n d/m/Y" }}</p>
                </div>
            </div>
        {% empty %}
            <p>No comments yet.</p>
        {% endfor %}
    </div>
    <form id="comment-form" method="post" action="{% url 'feed:comment' task_instance.id %}">
        {% csrf_token %}
        <div class="form-group">
            <label for="text">Add a comment:</label>
            <textarea name="text" id="text" class="form-control" rows="3" required></textarea>
        </div>
    </form>
  </div>
  <script>
    var commentForm = document.getElementById('comment-form');
    var messageInput = document.getElementById('text');
    messageInput.addEventListener('keydown', function(event) {
      if (event.keyCode === 13 && !event.shiftKey) {
        event.preventDefault();
        var messageContent = messageInput.value.trim();
        if (messageContent) {
          var csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
          var xhr = new XMLHttpRequest();
          xhr.open('POST', commentForm.action);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          xhr.setRequestHeader('X-CSRFToken', csrfToken);
          xhr.onload = function() {
            if (xhr.status === 200) {
              messageInput.value = '';
              fetchComments(); // Fetch latest comments
            }
          };
          xhr.send('text=' + encodeURIComponent(messageContent));
        }
      }
    });

    function fetchComments() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '{% url 'feed:task_detail' task_instance.id %}');
      xhr.onload = function() {
        if (xhr.status === 200) {
          var parser = new DOMParser();
          var html = parser.parseFromString(xhr.response, 'text/html');
          var newCommentsContainer = html.querySelector('#comments-container');
          var currentCommentsContainer = document.querySelector('#comments-container');
          currentCommentsContainer.innerHTML = newCommentsContainer.innerHTML;
        }
      };
      xhr.send();
    }
    
  </script>
{% endblock %}
